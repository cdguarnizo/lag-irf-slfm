function evalfun = nl_func(x,param,cas)
% This code is neccessry because of the update step in E_win_sde

if isfield(param,'incInput') && param.incInput,
    iout = 1:param.nout;
    iin = param.nout + 1:param.nout + param.nlf;
end

if ~isfield(param,'flag') || isempty(param.flag),
    param.flag = 1:size(param.H,1);
end

% sine as nonlinear function
M = param.H*x;
Ho = param.H(iout,:);
Hi = param.H(iin,:);
switch cas
    case 1, %Evaluation of the nonlinear function
        evalfun = [param.g_func(x,Ho); M(iin)];
    case 2, %Evaluation of gradient wrt x
        evalfun = [param.dg_dx_func(x,Ho); Hi];
    case 3, %Evaluation of gradient wrt H*x
        evalfun = [param.g_u(M(iout)); ones(param.nlf,1)];
    case 4, %Hessian wrt H*x
        evalfun = -sin(x);
end
evalfun = evalfun(param.flag);